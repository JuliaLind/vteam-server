checks:
  javascript: true

build:
  environment:
    variables:
      DB_NAME: "bikes"
      DB_ROOT_PASSWORD: "root"
      DB_USER: "root"
      DB_SERVICE_NAME: "localhost"
      TEST_DB_NAME: "test"
      TEST_SERVICE_NAME: "localhost"
      JWT_SECRET: "5d9e0b327c674d279771aed90ad876165d9e0b327c674d279771aed90ad87616"
  services:
    mariadb:
      image: mariadb:10.11.6
      ports:
        - 3306
      env:
        MARIADB_ROOT_PASSWORD: "root"
        MARIADB_DATABASE: "test"

  nodes:
    analysis:
      tests:
        stop_on_failure: true
        override:
          - 
            command: |
              nvm install 16
              nvm use --delete-prefix v16
              cd server
              npm install

              echo "Waiting for MariaDB..."
              while ! mysqladmin ping -h"$DB_SERVICE_NAME" --silent; do
                  sleep 1
              done

              mysql --local-infile -h localhost --protocol=TCP -u root -proot $TEST_DB_NAME < ../mariadb/docker/setup-test-scruti.sql

              npm run test
            coverage:
              file: 'server/coverage/clover.xml'
              format: 'clover'
